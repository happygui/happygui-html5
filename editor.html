<!DOCTYPE html>
<html>
<head>
  <title>HappyGUI</title>
  <link rel="stylesheet" type="text/css" href="css/default.css" />
</head>
<body>
<div class="wrapper">
  <div id="page"></div>
  <div id="editor" class="hidden">
    <!-- editorViews will be imported here -->
  </div>

  <div id="preview" class="hidden">
    <!-- elements drawn by the user -->
  </div>
</div>

<script type="text/javascript" src="js/handlebars.js"></script>
<script type="text/javascript" src="build/build.js"></script>

<script id="homepage_tpl" type="text/html">
  <div class="btn-block">
    <a href="#collection" class="btn green_bg">Open</a>
    <a href="#new" class="btn pink_bg">Create new</a>
    <a href="#help" class="btn yellow_bg">Help</a>
  </div>
</script>

<script id="newpage_tpl" type="text/html">
  <div class="centred" id="newpage">
    <div><input id="collectionName" placeholder="Enter a name" value=""/></div>
    <div id="collectionSave" class="btn orange_bg">Save</div>
  </div>
</script>

<script id="help_tpl" type="text/html">
  Help page
</script>

<script id="collection_tpl" type="text/html">
  {{#if collection }}
    {{#collection}}
      <a href="#editor/{{@index}}">
      <div class="collection">
        <div class="preview">
          <!-- Image here -->
        </div>
        <div class="title">{{name}}</div>
      </div>
      </a>
    {{/collection}}
  {{else}}
  <div class="centred">No app drawn yet, <a href="#new">create one!</a></div>
  {{/if}}
</script>

<script id="editor_tpl" type="text/html">
  <header>
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
  </header>

  <section id="elementsNew">
    <div class="elementNew" id="squareNew">
      Square
    </div>
    <div class="elementNew" id="circleNew">
      Circle
    </div>
    <div class="elementNew" id="textNew">
      Text
    </div>
    <div class="elementNew" id="cameraNew">
      Camera
    </div>
    <div class="elementNew" id="imageNew">
      Image
    </div>
  </section>

  <footer>

  </footer>

</script>

<script id="element_editor_tpl" type="text/html">
  <header>

  </header>

  <section>
    {{#hasBackground}}
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
    {{/hasBackground}}
    {{#hasBorderColor}}
    <div class="colorpicker cpBorderColor" style="background-color: {{borderColor}};">
    </div>
    {{/hasBorderColor}}
    {{#hasFontColor}}
    <div class="colorpicker cpFontColor" style="background-color: {{fontColor}};">
    </div>
    {{/hasFontColor}}
    {{#hasBorderThickness}}
    <div class="sizemodifier smBorderThickness">
      <label>Border thickness<input value="{{borderThickness}}" name="smBorderThickness" /></label>
    </div>
    {{/hasBorderThickness}}
    {{#hasFontSize}}
    <div class="sizemodifier smFontSize">
      <label>Font size<input value="{{fontSize}}" name="smFontSize" /></label>
    </div>
    {{/hasFontSize}}
  </section>

  <footer>
    {{#isDeletable}}
    <button class="btn-editor btn-delete">Delete</button>
    {{/isDeletable}}
  </footer>

</script>

<script type="text/javascript">
  // Dependencies
  var Router = require('apily-router');
  var delegate = require('component-delegate');
  var event = require('component-event');
  var Emitter = require('component-emitter');

  // Happygui dependencies
  var Element = require('happygui-element');
  var TextElement = require('happygui-textelement');
  var ShapeElement = require('happygui-shapeelement');
  var Collection = require('happygui-collection');
  var View = require('happygui-view');

  /* Quick quick fix */
  Storage.prototype.setObject = function(key, value) {
    this.setItem(key, JSON.stringify(value));
  };

  Storage.prototype.getObject = function(key) {
    var value = this.getItem(key);
    return value && JSON.parse(value);
  };

  // Singleton
  var CollectionCtrl = (function(){

    var get = function () {
      if (localStorage) {
        return localStorage.getObject('happygui-collection');
      } else {
        return alert("You are using a platform which is not recognised!");
      }
    };

    var save = function () {
      if (localStorage) {
        localStorage.setObject('happygui-collection', filesCollection.models);
      } else {
        // TODO throw an error
        alert("You are using a platform which is not recognised!");
      }
    };

    var create = function (obj) {
      filesCollection.push(obj);
      save();
    };

    var reset = function () {
      filesCollection.models = [];
      if (localStorage) {
        localStorage.clear();
      } else {
        // TODO throw an error
        alert("You are using a platform which is not recognised!");
      }
    };

    var filesCollection = new Collection(get());

    return {
      get: function() {
        return filesCollection.models;
      },
      getCollection: function (collection) {
        collection = collection || this.currentCollection;
        return filesCollection.models[collection];
      },
      getElement: function(element, collection) {
        collection = collection || this.currentCollection;
        element = element || this.currentElement;

        return filesCollection.models[collection].elements[element];
      },
      update: function (doc, collection) {
        if (doc && collection) {
          filesCollection.models[collection] = doc;
        }
        else if (doc) {
          filesCollection.models = doc;
        }
        save();
      },
      create: function() {
        var name = document.getElementById("collectionName").value;
        create({name: name, elements: []});
        document.getElementById("collectionName").value = '';
        window.location = "#editor/" + (filesCollection.length()-1);
        return this;
      },
      createElement: function (collection, doc) {
        var element;

        switch (doc.type) {
          case "image":
            break;
          case "circle":
            break;
          case "text":
            element = new TextElement(doc);
            break;
          default:

            //TODO throw error
            alert("type not recognised, sorry");
        }

        return filesCollection.models[collection].elements.push(element);
      },
      reset: function() {
        if (confirm("Your data will be lost forever, are you fine with that?")) {
          reset();
        }
        return this;
      }
    }
  })();

  // Singleton
  var Templates = (function (){
    var templates = {};
    var allScripts = document.getElementsByTagName('script');

    function compile (doc) {
      return Handlebars.compile(doc.innerHTML);
    }

    for (var i=0; i<allScripts.length; i++) {
      if (allScripts[i].getAttribute('type') === 'text/html') {
        templates[allScripts[i].getAttribute('id').replace("_tpl",'')] = compile(allScripts[i]);
      }
    }

    return {
      get: function (template) {
        return templates[template];
      }
    };
  })();

  function PreviewView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "preview";

    return this;
  }
  PreviewView.prototype = Object.create(View.prototype);
  PreviewView.prototype.constructor = PreviewView;

  PreviewView.prototype.render = function () {

    this.el("").show();
    return this;
  };

  function PageView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "page";

    return this;
  }
  PageView.prototype = Object.create(View.prototype);
  PageView.prototype.constructor = PageView;

  PageView.prototype.clear = function() {
    this.el('');
    return this;
  };

  PageView.prototype.render = function (template, data) {

    this
        .el(Templates.get(template)(data))
        .show();

    return this;
  };

  function EditorView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "editor";

    this.currentCollection = options.collection;
    this.currentElement = options.element;

    return this;
  }
  EditorView.prototype = Object.create(View.prototype);
  EditorView.prototype.constructor = EditorView;

  EditorView.prototype.elements = function(element) {
    if (typeof element == 'undefined') {
      return CollectionCtrl.getCollection(this.currentCollection);
    }

    return CollectionCtrl.getElement(element);
  };

  EditorView.prototype.setCollection = function(collection) {
    this.currentCollection = collection;
    // TODO throw errors
    return this;
  };

  EditorView.prototype.setElement = function (type, id) {
    // TODO throw errors
    if (type) {
      this.currentElement = id || CollectionCtrl.createElement(this.currentCollection, {type: type});
      console.log(editor.currentElement);
    } else {

    }

    return this;
  };

  EditorView.prototype.select = function(collection, element) {

    element = element || {};

    this.setCollection(collection)
        .setElement(element.type, element.id);

    return this;
  };

  EditorView.prototype.render = function () {
    var html, data;

    if (this.currentElement) {
      data = this.currentElement || {name: "Hello"};
      html = Templates.get("element_editor")(data);
    } else {
      data = {name: "ciao"};
      html = Templates.get("editor")(data);
    }

    this.el(html).show();

    return this;
  };

  // Views service
  var Views = function(editorView, previewView, pageView) {
    return {
      homepage: function() {

        pageView
            .render('homepage', null)

      },
      newpage: function() {

        pageView
            .render('newpage', null);

      },
      editor: function(collection) {

        editorView
            .select(collection, null)
            .render();

        previewView
            .render();

      },
      help: function() {

        pageView
            .render('help', null);

        console.log("YUHU WE ARE IN help");
      },
      collection: function() {

        console.log(CollectionCtrl.get());
        pageView
            .render("collection", {collection: CollectionCtrl.get()});

      },
      element_editor: function(collection, type, id) {

        editorView
            .select(collection, {type: type, id: id})
            .render();

        previewView
            .render();

      }
    }
  };

  // Main
  var editor = new EditorView({container: 'editor'});
  editor.bind('click .elementNew', function(e) {
    var type = e.target.id.replace('New','');
    window.location = "#editor/"+editor.currentCollection+"/"+type;
  });
  var preview = new PreviewView({container: 'preview'});
  var page = new PageView({container: 'page'});
  page.bind('click #collectionSave', CollectionCtrl.create);
  var views = Views(editor, preview, page);

  // Clean before router cleans
  window.addEventListener("hashchange", function() {
    editor.hide();
    preview.hide();
    page.hide();
  }, true);

  var router = new Router();
  router
      .route('#homepage', views.homepage)
      .route('#new', views.newpage)
      .route("#help", views.help)
      .route("#collection", views.collection)
      .route('#editor/:collection', views.editor)
      .route('#editor/:collection/:type', views.element_editor)
      .route('#editor/:collection/:type/:id', views.element_editor)
      .history.start();


  // This happens on page refresh
  if (window.location.hash === "") {
    window.location.hash = "#homepage"
  } else {
    //TODO load view
  }


</script>

</body>
</html>