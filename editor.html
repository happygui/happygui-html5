<!DOCTYPE html>
<html>
<head>
  <title>HappyGUI</title>
  <link rel="stylesheet" type="text/css" href="css/default.css" />
</head>
<body>
<div class="wrapper">
  <div id="page"></div>
  <div id="editor" class="hidden">
    <!-- editorViews will be imported here -->
  </div>

  <div id="preview" class="hidden">
    <!-- elements drawn by the user -->
  </div>
</div>

<script type="text/javascript" src="js/handlebars.js"></script>
<script type="text/javascript" src="build/build.js"></script>

<script id="homepage_tpl" type="text/html">
  <div class="btn-block">
    <a href="#collection" class="btn green_bg">Open</a>
    <a href="#new" class="btn pink_bg">Create new</a>
    <a href="#help" class="btn yellow_bg">Help</a>
  </div>
</script>

<script id="newpage_tpl" type="text/html">
  <div class="centred" id="newpage">
    <div><input id="collectionName" placeholder="Enter a name" value=""/></div>
    <div id="collectionSave" class="btn orange_bg">Save</div>
  </div>
</script>

<script id="help_tpl" type="text/html">
  Help page
</script>

<script id="collection_tpl" type="text/html">
  {{#if collection }}
    {{#collection}}
      <a href="#editor/{{@index}}">
      <div class="collection">
        <div class="preview">
          <!-- Image here -->
        </div>
        <div class="title">{{name}}</div>
      </div>
      </a>
    {{/collection}}
  {{else}}
  <div class="centred">No app drawn yet, <a href="#new">create one!</a></div>
  {{/if}}
</script>

<script id="editor_tpl" type="text/html">
  <header>
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
  </header>

  <section id="elementsNew">
    <div class="elementNew" id="squareNew">
      Square
    </div>
    <div class="elementNew" id="circleNew">
      Circle
    </div>
    <div class="elementNew" id="TextNew">
      Text
    </div>
    <div class="elementNew" id="cameraNew">
      Camera
    </div>
    <div class="elementNew" id="imageNew">
      Image
    </div>
  </section>

  <footer>

  </footer>

</script>

<script id="element_editor_tpl" type="text/html">
  <header>

  </header>

  <section>
    {{#hasBackground}}
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
    {{/hasBackground}}
    {{#hasBorderColor}}
    <div class="colorpicker cpBorderColor" style="background-color: {{borderColor}};">
    </div>
    {{/hasBorderColor}}
    {{#hasFontColor}}
    <div class="colorpicker cpFontColor" style="background-color: {{fontColor}};">
    </div>
    {{/hasFontColor}}
    {{#hasBorderThickness}}
    <div class="sizemodifier smBorderThickness">
      <label>Border thickness<input value="{{borderThickness}}" name="smBorderThickness" /></label>
    </div>
    {{/hasBorderThickness}}
    {{#hasFontSize}}
    <div class="sizemodifier smFontSize">
      <label>Font size<input value="{{fontSize}}" name="smFontSize" /></label>
    </div>
    {{/hasFontSize}}
  </section>

  <footer>
    {{#isDeletable}}
    <button class="btn-editor btn-delete">Delete</button>
    {{/isDeletable}}
  </footer>

</script>

<script type="text/javascript">
  var Router = require('apily-router');
  var delegate = require('component-delegate');
  var event = require('component-event');
  var Emitter = require('component-emitter');

  /* Momentaneous quick fix */
  Storage.prototype.setObject = function(key, value) {
    this.setItem(key, JSON.stringify(value));
  }

  Storage.prototype.getObject = function(key) {
    var value = this.getItem(key);
    return value && JSON.parse(value);
  }

  function Collection(models) {
    this.models = models || [];
  }

  Collection.prototype.__iterate__ = function(){
    var self = this;
    return {
      length: function(){ return self.length() },
      get: function(i){ return self.models[i] }
    }
  };

  Collection.prototype.length = function(){
    return this.models.length;
  };

  Collection.prototype.push = function(model){
    return this.models.push(model);
  };

  // Adapter


  // Singleton
  var CollectionCtrl = (function(){

    var get = function () {
      if (localStorage) {
        return localStorage.getObject('happygui-collection');
      } else {
        return alert("You are using a platform which is not recognised!");
      }
    };

    var create = function (obj) {
      filesCollection.push(obj);

      if (localStorage) {
        localStorage.setObject('happygui-collection', filesCollection.models);
      } else {
        return alert("You are using a platform which is not recognised!");
      }
    };

    var reset = function () {
      filesCollection.models = [];
      localStorage.clear();
    };

    var filesCollection = new Collection(get());

    return {
      get: function() {
        return filesCollection.models;
      },
      getCollection: function (index) {
        return filesCollection.models[index];
      },
      create: function() {
        var name = document.getElementById("collectionName").value;
        create({name: name, elements: []});
        document.getElementById("collectionName").value = '';
        window.location = "#editor/" + (filesCollection.length()-1);
        return this;
      },
      reset: function() {
        if (confirm("Your data will be lost forever, are you fine with that?")) {
          reset();
        }
        return this
      }
    }
  })();

  // Singleton
  var Templates = (function Templates2 (){
    var templates = {};
    var allScripts = document.getElementsByTagName('script');

    function compile (doc) {
      return Handlebars.compile(doc.innerHTML);
    }

    for (var i=0; i<allScripts.length; i++) {
      if (allScripts[i].getAttribute('type') === 'text/html') {
        templates[allScripts[i].getAttribute('id').replace("_tpl",'')] = compile(allScripts[i]);
      }
    }

    return {
      get: function (template) {
        return templates[template];
      }
    };
  })();

  function View (options) {
    options = options || {};

    this.defaultContainer = "example";
    this.container = options.container;
    this.hidden = false;
  }
  View.prototype = Object.create(Emitter.prototype);

  View.prototype.broadcast = function(emitter, event, method) {
  };

  View.prototype.bind = function(str, method) {
    // From component/view
    var parts = str.split(' ');
    var event = parts.shift();
    var selector = parts.join(' ');
/*    var meth = this[method];
    if (!meth) throw new TypeError('method "' + method + '" is not defined');
*/
    var meth = method;
    var fn = delegate.bind(document.getElementById(this.container || this.defaultContainer), selector, event, meth.bind(this));
  };

  View.prototype.show = function() {
    if (this.hidden == true) {
      this.hidden = false;
      document.getElementById(this.container || this.defaultContainer).className = "";
    }

    return this;
  };

  View.prototype.hide = function() {
    if (this.hidden == false) {
      this.hidden = true;
      document.getElementById(this.container || this.defaultContainer).className = "hidden";
    }

    return this;
  };

  View.prototype.el = function(html) {
    document.getElementById(this.container || this.defaultContainer).innerHTML = html;

    return this;
  };

  function PreviewView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "preview";

    return this;
  }
  PreviewView.prototype = Object.create(View.prototype);
  PreviewView.prototype.constructor = PreviewView;

  PreviewView.prototype.render = function () {

    this.el("").show();
    return this;
  };

  function PageView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "page";

    return this;
  }
  PageView.prototype = Object.create(View.prototype);
  PageView.prototype.constructor = PageView;

  PageView.prototype.clear = function() {
    this.el('');
    return this;
  };

  PageView.prototype.render = function (template, data) {

    this
        .el(Templates.get(template)(data))
        .show();

    return this;
  };

  function EditorView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "editor";

    this.currentCollection = options.collection;
    this.currentElement = options.element;

    this.elements = new Collection(options.elements);

    return this;
  }
  EditorView.prototype = Object.create(View.prototype);
  EditorView.prototype.constructor = EditorView;

  EditorView.prototype.select = function(collection, element) {

    this.currentElement = element || null;

    if (element == null || element == false || typeof element == 'undefined'){
      this.currentCollection = collection;
    }

    console.log(CollectionCtrl.getCollection(this.currentCollection))

    // TODO throw an error
    this.elements = CollectionCtrl.getCollection(this.currentCollection)['elements'] || [];

    console.log("EditorView#select ", this.currentElement, this.currentCollection);

    return this;
  };

  EditorView.prototype.render = function () {
    var html, data;

    if (this.currentElement) {
      data = {name: "Hello"};
      html = Templates.get("element_editor")(data);
      console.log("rendering element_editor", this.currentElement);
    } else {
      data = {name: "ciao"};
      html = Templates.get("editor")(data);
      console.log("rendering editor", this.elements);
    }

    this.el(html).show();

    return this;
  };

  // Element Class
  function Element(options) {
    this.isDeletable = options.isDeletable;
  }

  // TextElement Class
  var TextElement = function(options) {
    Element.call(this, options); // Super

    this.hasFontSize = true;
    this.hasFontColor = true;

    this.fontSize = "13px";
    this.fontColor = "#000";
  };
  TextElement.prototype = Object.create(Element.prototype);
  TextElement.prototype.constructor = TextElement;

  // TextElement Class
  var ShapeElement = function(options) {
    Element.call(this, options); // Super

    this.hasBorderColor = true;
    this.hasBorderThickness = true;
    this.hasBackgroundColor = true;

    this.borderColor = "#cc0000";
    this.borderThickness = "5px";
    this.backgroundColor = "#00cc00";
  };
  ShapeElement.prototype = Object.create(Element.prototype);
  ShapeElement.prototype.constructor = ShapeElement;

  // Views service
  var Views = function(editorView, previewView, pageView) {
    return {
      homepage: function() {

        pageView
            .render('homepage', null)

      },
      newpage: function() {

        pageView
            .render('newpage', null);

      },
      editor: function(collection) {

        editorView
            .select(collection, null)
            .render();

        previewView
            .render();

      },
      help: function() {

        pageView
            .render('help', null);

        console.log("YUHU WE ARE IN help");
      },
      collection: function() {

        console.log(CollectionCtrl.get());
        pageView
            .render("collection", {collection: CollectionCtrl.get()});

      },
      element_editor: function(collection,type, id) {

        editorView
            .select(collection, {type: type, id: id})
            .render();

        previewView
            .render();

      }
    }
  };

  // Main
  var editor = new EditorView({container: 'editor'});
  var preview = new PreviewView({container: 'preview'});
  var page = new PageView({container: 'page'});
  page.bind('click #collectionSave', CollectionCtrl.create);
  var views = Views(editor, preview, page);

  // Clean before router cleans
  window.addEventListener("hashchange", function() {
    editor.hide();
    preview.hide();
    page.hide();
  }, true);

  var router = new Router();
  router
      .route('#homepage', views.homepage)
      .route('#new', views.newpage)
      .route("#help", views.help)
      .route("#collection", views.collection)
      .route('#editor/:collection', views.editor)
      .route('#editor/:collection/:type', views.element_editor)
      .route('#editor/:collection/:type/:id', views.element_editor)
      .history.start();


  // This happens on page refresh
  if (window.location.hash === "") {
    window.location.hash = "#homepage"
  } else {
    //TODO load view
  }


</script>

</body>
</html>