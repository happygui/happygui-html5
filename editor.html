<!DOCTYPE html>
<html>
<head>
  <title>HappyGUI</title>
  <link rel="stylesheet" type="text/css" href="css/default.css" />
</head>
<body>
<div class="wrapper">
  <div id="page"></div>
  <div id="editor" class="hidden">
    <!-- editorViews will be imported here -->
  </div>
  <div id="dialog_colorpicker" class="hidden">
    <div class="inner">
      <div class="row">
        <div class="colorpicker green_bg"></div>
        <div class="colorpicker pink_bg"></div>
        <div class="colorpicker yellow_bg"></div>
        <div class="colorpicker orange_bg"></div>
      </div>
      <div class="row">
        <div class="colorpicker white_bg"></div>
        <div class="colorpicker gray_bg"></div>
        <div class="colorpicker dgray_bg"></div>
        <div class="colorpicker black_bg"></div>

      </div>
    </div>
  </div>

  <div id="preview" class="hidden">
    <!-- elements drawn by the user -->
  </div>
</div>

<script type="text/javascript" src="js/handlebars.js"></script>
<script type="text/javascript" src="build/build.js"></script>

<script id="homepage_tpl" type="text/html">
  <div class="btn-block">
    <a href="#collection" class="btn green_bg">Open</a>
    <a href="#new" class="btn pink_bg">Create new</a>
    <a href="#help" class="btn yellow_bg">Help</a>
  </div>
</script>

<script id="newpage_tpl" type="text/html">
  <div class="centred" id="newpage">
    <div><input id="collectionName" placeholder="Enter a name" value="" autofocus="autofocus"/></div>
    <div id="collectionSave" class="btn orange_bg">Save</div>
  </div>
</script>

<script id="help_tpl" type="text/html">
  Help page
</script>

<script id="collection_tpl" type="text/html">
  {{#if collection }}
    {{#collection}}
      <a href="#editor/{{@index}}">
      <div class="collection">
        <div class="preview">
          <!-- Image here -->
        </div>
        <div class="title">{{name}}</div>
      </div>
      </a>
    {{/collection}}
  {{else}}
  <div class="centred">app drawn yet, <a href="#new">create one!</a></div>
  {{/if}}
</script>

<script id="editor_tpl" type="text/html">
  <header>
    <div id="cp_backgroundColor" class="colorpicker go-cpDialog" style="background-color: {{backgroundColor}};">
    </div>
  </header>

  <section id="elementsNew">
    <div class="row">
      <div class="elementNew" id="rectNew">
        &nbsp;
      </div>
      <div class="elementNew" id="circleNew">
        &nbsp;
      </div>
      <div class="elementNew" id="textNew">
        T
      </div>
      <div class="elementNew" id="cameraNew">
        Camera
      </div>
    </div>
    <div class="row">
      <div class="elementNew" id="imageNew">
        Image
      </div>
    </div>
  </section>

  <footer>

  </footer>

</script>

<script id="element_editor_tpl" type="text/html">
  <header>

  </header>

  <section>
    {{#hasBackgroundColor}}
    <div id="cp_backgroundColor" class="colorpicker go-cpDialog" style="background-color: {{backgroundColor}};">
    </div>
    {{/hasBackgroundColor}}
    {{#hasBorderColor}}
    <div id="cp_borderColor" class="colorpicker go-cpDialog" style="background-color: {{borderColor}};">
    </div>
    {{/hasBorderColor}}
    {{#hasFontColor}}
    <div id="cp_fontColor" class="colorpicker go-cpDialog" style="background-color: {{fontColor}};">
    </div>
    {{/hasFontColor}}
    {{#hasBorderThickness}}
    <div class="sizemodifier sm_borderThickness">
      <label>Border<input value="{{borderThickness}}" name="sm_borderThickness" /></label>
    </div>
    {{/hasBorderThickness}}
    {{#hasFontSize}}
    <div class="sizemodifier sm_fontSize">
      <label>Size<input value="{{fontSize}}" name="sm_fontSize" /></label>
    </div>
    {{/hasFontSize}}
    {{#hasWidth}}
    <div class="sizemodifier sm_width">
      <label>Width<input value="{{width}}" name="sm_width" /></label>
    </div>
    {{/hasWidth}}
    {{#hasHeight}}
    <div class="sizemodifier sm_height">
      <label>Height<input value="{{height}}" name="sm_height" /></label>
    </div>
    {{/hasHeight}}
    {{#hasRadius}}
    <div class="sizemodifier sm_r">
      <label>Radius<input value="{{r}}" name="sm_r" /></label>
    </div>
    {{/hasRadius}}
  </section>

  <footer>
    {{#isDeletable}}
    <a class="btn-editor btn-delete">Delete</a>
    {{/isDeletable}}
    <a class="btn-editor go-editor green_bg">Editor</a>
  </footer>

</script>

<script type="text/javascript">
  // Dependencies
  var Router = require('apily-router');
  var delegate = require('component-delegate');
  var event = require('component-event');
  var Emitter = require('component-emitter');
  var Raphael = require('richthegeek-raphael');

  // Happygui dependencies
  var View = require('happygui-view');
  var Templates = require('happygui-templates');

  // Happygui exceptions
  var NullElementException = require('happygui-nullelementexception');
  var NullCollectionException = require('happygui-nullcollectionexception');
  var NoPlatformException = require('happygui-noplatformexception');

  var StorageCtrl = require('happygui-storagectrl');

  function ColorPicker (options) {
    View.call(this, options);
    options = options || {};
    this.hidden = true;
    this.type = null;
    return this;
  }
  ColorPicker.prototype = Object.create(View.prototype);
  ColorPicker.prototype.constructor = ColorPicker;

  function PreviewView (options) {
    View.call(this, options);
    options = options || {};

    this.paper = Raphael(document.getElementById(options.container), 480, 600);

    return this;
  }
  PreviewView.prototype = Object.create(View.prototype);
  PreviewView.prototype.constructor = PreviewView;

  PreviewView.prototype.render = function (currentCollection) {
    var html = "", element, i = 0;
    var collection = StorageCtrl.getCollection(currentCollection);

    document.getElementById(this.container).style.backgroundColor = collection.backgroundColor;
    var self = this;

    if (collection.elements.length > 0)
    collection.elements.forEach(function(element, currentElement) {

      element.draw(self.paper, function() {
        StorageCtrl.update(false, element, currentCollection, currentElement);
        window.location = "#editor/"+currentCollection+"/"+element.type+"/"+currentElement;
      });
    });

    this.show();

    return this;
  };

  function PageView (options) {
    View.call(this, options);
    options = options || {};

    return this;
  }
  PageView.prototype = Object.create(View.prototype);
  PageView.prototype.constructor = PageView;

  PageView.prototype.clear = function() {
    this.el('');
    return this;
  };

  PageView.prototype.render = function (template, data) {

    this
        .el(Templates.getCollections(template)(data))
        .show();

    return this;
  };

  function EditorView (options) {
    View.call(this, options);
    options = options || {};

    this.currentCollection = options.collection;
    this.currentElement = options.element || false;

    this.colorpicker = new ColorPicker({container: options.colorpicker});

    return this;
  }
  EditorView.prototype = Object.create(View.prototype);
  EditorView.prototype.constructor = EditorView;

  EditorView.prototype.collection = function () {
    return StorageCtrl.getCollection(this.currentCollection);
  };
  EditorView.prototype.elements = function (element) {
    if (element === null) {
      return StorageCtrl.getElements(this.currentCollection);
    }

    return StorageCtrl.getElement(element, this.currentCollection);
  };
  EditorView.prototype.element = function (element) {
    return this.elements(element || this.currentElement);
  };

  EditorView.prototype.setCollection = function (collection) {
  	collection = parseInt(collection);
  	if (isNaN(collection)) throw new NullCollectionException ("Collection id must be a number");
    this.currentCollection = collection; // TODO try&catch errors

    return this;
  };

  EditorView.prototype.setAttribute = function (key, value) {
    StorageCtrl.setElementAttribute(this.currentElement, this.currentCollection, key, value);
    var attr;
    this.element().redraw();
  };

  EditorView.prototype.setElement = function (type, id) {
      this.currentElement = id || StorageCtrl.createElement(this.currentCollection, {type: type});
    return this;
  };

  EditorView.prototype.saveElement = function (toSave, doc) {
    StorageCtrl.update(toSave, doc, this.currentCollection, this.currentElement);
  };

  EditorView.prototype.select = function(collection, element) {


    this.setCollection(collection);

    if (element !== undefined ) {
		  this.setElement(element.type, element.id);
	  }
    	    
    return this;
  };

  EditorView.prototype.reset = function () {
    this.currentCollection = null;
    this.currentElement = null;
    return this;
  };

  EditorView.prototype.render = function () {
    var html, data;

    if (this.currentElement !== null) {
      data = this.elements(this.currentElement);
      html = Templates.getCollections("element_editor")(data);
    } else {
      data = this.collection();
      html = Templates.getCollections("editor")(data);
    }

    this.el(html).show();

    return this;
  };

  // Views service
  var Views = function(editorView, previewView, pageView) {
    return {
      homepage: function() {

        pageView
            .render('homepage', null)

      },
      newpage: function() {

        pageView
            .render('newpage', null);

      },
      editor: function(collection) {

		    try {

		        editorView
		            .reset()
		            .select(collection)
		            .render();
	
		    } catch(exception) {
			  console.log(exception, exception.message);
		    
		    // TODO this should not appear in history
			  if (exception instanceof NullCollectionException) {
			  	this.currentCollection = null;
			    window.location = "#collection";
			    return null;
			  }
/*
		      if (exception instanceof NullElement) {
			  	this.currentElement = null;
			  }
*/

			}
			
			previewView
				.render(collection);

      },
      help: function() {

        pageView
            .render('help', null);

      },
      collection: function() {

        pageView
            .render("collection", {collection: StorageCtrl.getCollections()});

      },
      colorpicker: function(collection, type) {
        editorView
            .reset()
            .select(collection);

        editorView.colorpicker.type = type;
        editorView.colorpicker
            .show();

        previewView
            .render(collection);
      },
      element_colorpicker: function(collection, type, id) {
        editorView
            .reset()
            .select(collection, {id: id});

        editorView.colorpicker.type = type;
        editorView.colorpicker
            .show();

        previewView
            .render(collection);
      },
      element_editor: function(collection, type, id) {

        try {
          editorView
              .reset()
              .select(collection, {type: type, id: id});

          if (id) {
            editorView.render();
          } else {
            window.location = "#editor/"+collection+"/"+type+"/"+editorView.currentElement;
            // delete history
            return this;
          }

        } catch(exception) {

          // TODO this should not appear in history
          if (exception instanceof NullCollectionException) {
            this.currentCollection = null; //TODO CHECK
            window.location = "#collection";
            return null;
          } else if (exception instanceof NullElementException) {
            this.currentElement = null;
            window.location = "#editor/"+collection;
          } else {
            console.log(exception, exception.message);
          }

        }

        previewView
            .render(collection);

      }
    }
  };

  // Main
  var editor = new EditorView({container: 'editor', colorpicker: 'dialog_colorpicker'});
  editor.bind('click .elementNew', function(e) {
    var type = e.target.id.replace('New','');
    try {
      var id = StorageCtrl.createElement(this.currentCollection, {type: type});
    } catch(exception) {
      if (exception instanceof NullElementException) {
        alert("You selected an element that doesn't exist")
        window.location = "#editor/"+this.currentCollection;
      } else {
        console.log(exception);
      }
    }
    window.location = "#editor/"+this.currentCollection+"/"+type+"/"+id;
  });
  editor.bind('keyup #editor input', function(e) {
    var key = e.target.name.replace("sm_", "");
    var value = e.target.value;
    this.setAttribute(key, value);
  });
  editor.bind('click #editor .btn-delete', function(e) {
    StorageCtrl.delElement(this.currentElement, this.currentCollection);
    window.location = "#editor/"+this.currentCollection;
  });
  editor.bind('click #editor .go-editor', function(e) {
    window.location = "#editor/"+this.currentCollection;
  });
  editor.bind('click #editor .go-cpDialog', function(e) {
    var type = e.target.id.replace('cp_','');
    var element = editor.currentElement === null ? "" : "/"+editor.currentElement;
    window.location = "#colorpicker/"+this.currentCollection+"/"+type+element;
  });
  editor.colorpicker.bind('click #dialog_colorpicker .colorpicker', function(e){
    var color = window.getComputedStyle(e.target).getPropertyValue('background-color');
    var url;
    try {
      editor.setAttribute(editor.colorpicker.type, color);
      var type = editor.element().type;
      url = '#editor/'+editor.currentCollection+'/'+type+'/'+editor.currentElement;
    } catch (exception) {
      if (exception instanceof NullElementException) {
        url = '#editor/'+editor.currentCollection;
        StorageCtrl.setCollectionAttribute(editor.currentCollection, editor.colorpicker.type, color);
      } else {
        console.log(exception);
      }
    } finally {
      this.hide();
      window.location = url;
    }
  });

  var preview = new PreviewView({container: 'preview'});

  var page = new PageView({container: 'page'});
  page.bind('click #collectionSave', StorageCtrl.createCollection);
  var views = Views(editor, preview, page);

  // Clean before router cleans
  window.addEventListener("hashchange", function() {
    editor.hide();
    editor.colorpicker.hide();
    // TODO move preview paper clear from here
    // TODO dont clear/redraw when same collection
    preview.paper.clear();
    preview.hide();
    page.hide();
  }, true);

  var router = new Router();
  router
      .route('#homepage', views.homepage)
      .route('#new', views.newpage)
      .route("#help", views.help)
      .route("#collection", views.collection)
      .route('#editor/:collection', views.editor)
      .route('#editor/:collection/:type', views.element_editor)
      .route('#editor/:collection/:type/:id', views.element_editor)
      .route('#colorpicker/:collection/:type', views.colorpicker)
      .route('#colorpicker/:collection/:type/:id', views.element_colorpicker)
      .history.start();


  // This happens on page refresh
  if (window.location.hash === "") {
    window.location.hash = "#homepage"
  } else {
    //TODO load view
  }


</script>

</body>
</html>