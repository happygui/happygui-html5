<!DOCTYPE html>
<html>
<head>
  <title>HappyGUI</title>
  <link rel="stylesheet" type="text/css" href="css/default.css" />
</head>
<body>
<div class="wrapper">
  <div id="page"></div>
  <div id="editor" class="hidden">
    <!-- editorViews will be imported here -->
  </div>

  <div id="preview" class="hidden">
    <!-- elements drawn by the user -->
  </div>
</div>

<script type="text/javascript" src="js/handlebars.js"></script>
<script type="text/javascript" src="build/build.js"></script>

<script id="homepage_tpl" type="text/html">
  <div class="btn-block">
    <a href="#collection" class="btn green_bg">Open</a>
    <a href="#new" class="btn pink_bg">Create new</a>
    <a href="#help" class="btn yellow_bg">Help</a>
  </div>
</script>

<script id="newpage_tpl" type="text/html">
  <div class="centred" id="newpage">
    <div><input placeholder="Enter a name" value=""/></div>
    <div class="btn orange_bg">Save</div>
  </div>
</script>

<script id="help_tpl" type="text/html">
  Help page
</script>

<script id="collection_tpl" type="text/html">
  {{#if collections }}

  {{else}}
  <div class="centred"> No app drawn yet, <a href="#new">create one!</a></div>
  {{/if}}
</script>

<script id="editor_tpl" type="text/html">
  <header>
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
  </header>

  <section>
  </section>

  <footer>

  </footer>

</script>

<script id="element_editor_tpl" type="text/html">
  <header>

  </header>

  <section>
    {{#hasBackground}}
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
    {{/hasBackground}}
    {{#hasBorderColor}}
    <div class="colorpicker cpBorderColor" style="background-color: {{borderColor}};">
    </div>
    {{/hasBorderColor}}
    {{#hasFontColor}}
    <div class="colorpicker cpFontColor" style="background-color: {{fontColor}};">
    </div>
    {{/hasFontColor}}
    {{#hasBorderThickness}}
    <div class="sizemodifier smBorderThickness">
      <label>Border thickness<input value="{{borderThickness}}" name="smBorderThickness" /></label>
    </div>
    {{/hasBorderThickness}}
    {{#hasFontSize}}
    <div class="sizemodifier smFontSize">
      <label>Font size<input value="{{fontSize}}" name="smFontSize" /></label>
    </div>
    {{/hasFontSize}}
  </section>

  <footer>
    {{#isDeletable}}
    <button class="btn-editor btn-delete">Delete</button>
    {{/isDeletable}}
  </footer>

</script>

<script type="text/javascript">
  var Router = require('apily-router');


  function Collection(models) {
    this.models = models || [];
  }

  Collection.prototype.__iterate__ = function(){
    var self = this;
    return {
      length: function(){ return self.length() },
      get: function(i){ return self.models[i] }
    }
  };

  Collection.prototype.length = function(){
    return this.models.length;
  };

  Collection.prototype.push = function(model){
    return this.models.push(model);
  };


  var Templates = new function() {
    var compile = function(doc) {
      return Handlebars.compile(doc.innerHTML);
    };
    this.t = {};

    var allScripts = document.getElementsByTagName('script');
    for (var i=0; i<allScripts.length; i++) {
      if (allScripts[i].getAttribute('type') === 'text/html') {
        this.t[allScripts[i].getAttribute('id').replace("_tpl",'')] = compile(allScripts[i]);
      }
    }

    this.get = function (template) {
      return this.t[template];
    }
  };

  function View (options) {
    options = options || {};

    this.defaultContainer = "example";
    this.container = options.container;
    this.hidden = false;
  }

  View.prototype.show = function() {
    if (this.hidden == true) {
      this.hidden = false;
      document.getElementById(this.container || this.defaultContainer).className = "";
    }

    return this;
  };

  View.prototype.hide = function() {
    if (this.hidden == false) {
      this.hidden = true;
      document.getElementById(this.container || this.defaultContainer).className = "hidden";
    }

    return this;
  };

  View.prototype.el = function(html) {
    document.getElementById(this.container || this.defaultContainer).innerHTML = html;

    return this;
  };

  function PreviewView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "preview";

    return this;
  }
  PreviewView.prototype = Object.create(View.prototype);
  PreviewView.prototype.constructor = PreviewView;

  PreviewView.prototype.render = function () {

    this.el("").show();
    return this;
  };

  function EditorView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "editor";

    this.currentElement = options.element;
    this.elements = new Collection(options.elements);

    return this;
  }
  EditorView.prototype = Object.create(View.prototype);
  EditorView.prototype.constructor = EditorView;

  EditorView.prototype.select = function(element) {
    this.currentElement = element || null;

    console.log("EditorView#select ", this.element);

    return this;
  };

  EditorView.prototype.render = function () {
    var html, data;

    if (this.currentElement) {
      data = {name: "Hello"};
      html = Templates.get("element_editor")(data);
      console.log("rendering element_editor", this.currentElement);
    } else {
      data = {name: "ciao"};
      html = Templates.get("editor")(data);
      console.log("rendering editor", this.elements);
    }

    this.el(html).show();

    return this;
  };

  // Element Class
  function Element(options) {
    this.isDeletable = options.isDeletable;
  }

  // TextElement Class
  var TextElement = function(options) {
    Element.call(this, options); // Super

    this.hasFontSize = true;
    this.hasFontColor = true;

    this.fontSize = "13px";
    this.fontColor = "#000";
  };
  TextElement.prototype = Object.create(Element.prototype);
  TextElement.prototype.constructor = TextElement;

  // TextElement Class
  var ShapeElement = function(options) {
    Element.call(this, options); // Super

    this.hasBorderColor = true;
    this.hasBorderThickness = true;
    this.hasBackgroundColor = true;

    this.borderColor = "#cc0000";
    this.borderThickness = "5px";
    this.backgroundColor = "#00cc00";
  };
  ShapeElement.prototype = Object.create(Element.prototype);
  ShapeElement.prototype.constructor = ShapeElement;

  // Views service
  var Views = function(editorView, previewView) {
    return {
      homepage: function() {

        document.getElementById('page').innerHTML = Templates.get('homepage')(null);

        //TODO handle with events
        editorView.hide();
        previewView.hide();

        console.log("YUHU WE ARE IN HOMEPAGE");
      },
      newpage: function() {
        editorView
            .hide();
        previewView
            .hide();

        document.getElementById('page').innerHTML = Templates.get('newpage')(null);

        console.log("YUHU WE ARE IN NEWPAGE");
      },
      editor: function() {
        editorView
            .select(null)
            .render();

        previewView
            .render();

        console.log("YUHU WE ARE IN editor");
      },
      help: function() {
        editorView
            .hide();
        previewView
            .hide();

        document.getElementById('page').innerHTML = Templates.get('help')(null);

        console.log("YUHU WE ARE IN help");
      },
      collection: function() {
        editorView
            .hide();
        previewView
            .hide();

        document.getElementById('page').innerHTML = Templates.get('collection')({collection: []});

        console.log("YUHU WE ARE IN collection");
      },
      element_editor: function(type, id) {
        editorView
            .select({type: type, id: id})
            .render();

        previewView
            .render();

        console.log("YUHU WE ARE IN editor:"+type);
      }
    }
  };

  // Main
  var editor = new EditorView({container: 'editor'});
  var preview = new PreviewView({container: 'preview'});
  var filesCollection = new Collection(); // TODO here get files from system
  var views = Views(editor, preview);
  var router = new Router()
      .route('#homepage', views.homepage)
      .route('#new', views.newpage)
      .route("#help", views.help)
      .route("#collection", views.collection)
      .route('#editor', views.editor)
      .route('#editor/:type', views.element_editor)
      .route('#editor/:type/:id', views.element_editor)
      .history.start();

  if (window.location.hash === "") {
    window.location = "#homepage";
  }

</script>

</body>
</html>