<!DOCTYPE html>
<html>
<head>
  <title>HappyGUI</title>
  <link rel="stylesheet" type="text/css" href="css/default.css" />
</head>
<body>
<div class="wrapper">
  <div id="page"></div>
  <div id="editor" class="hidden">
    <!-- editorViews will be imported here -->
  </div>
  <div id="dialog_colorpicker" class="hidden">
    <div class="inner">
      <div class="row">
        <div class="colorpicker green_bg"></div>
        <div class="colorpicker pink_bg"></div>
        <div class="colorpicker yellow_bg"></div>
        <div class="colorpicker orange_bg"></div>
      </div>
      <div class="row">
        <div class="colorpicker white_bg"></div>
        <div class="colorpicker gray_bg"></div>
        <div class="colorpicker dgray_bg"></div>
        <div class="colorpicker black_bg"></div>

      </div>
    </div>
  </div>

  <div id="preview" class="hidden">
    <!-- elements drawn by the user -->
  </div>
</div>

<script type="text/javascript" src="js/handlebars.js"></script>
<script type="text/javascript" src="build/build.js"></script>

<script id="homepage_tpl" type="text/html">
  <div class="btn-block">
    <a href="#collection" class="btn green_bg">Open</a>
    <a href="#new" class="btn pink_bg">Create new</a>
    <a href="#help" class="btn yellow_bg">Help</a>
  </div>
</script>

<script id="newpage_tpl" type="text/html">
  <div class="centred" id="newpage">
    <div><input id="collectionName" placeholder="Enter a name" value="" autofocus="autofocus"/></div>
    <div id="collectionSave" class="btn orange_bg">Save</div>
  </div>
</script>

<script id="help_tpl" type="text/html">
  Help page
</script>

<script id="collection_tpl" type="text/html">
  {{#if collection }}
  <div class="topcentered">
    {{#collection}}
      <a href="#editor/{{@index}}">
      <div class="collection">
        <div class="preview">
          <!-- Image here -->
        </div>
        <div class="title">{{name}}</div>
      </div>
      </a>
    {{/collection}}
    <a href="#new">
      <div class="collection">
        <div class="preview pink_bg">
          <!-- Image here -->
        </div>
        <div class="title">Create a new one!</div>
      </div>
    </a>
  </div>
  {{else}}
  <div class="centred">You have no apps, <a href="#new">create one!</a></div>
  {{/if}}
</script>

<script id="editor_tpl" type="text/html">
  <header>
    <div id="cp_backgroundColor" class="colorpicker go-cpDialog" style="background-color: {{backgroundColor}};">
    </div>
  </header>

  <section id="elementsNew">
    <div class="row">
      <div class="elementNew" id="rectNew">
        &nbsp;
      </div>
      <div class="elementNew" id="circleNew">
        &nbsp;
      </div>
      <div class="elementNew" id="textNew">
        T
      </div>
      <div class="elementNew" id="cameraNew">
        Camera
      </div>
    </div>
    <div class="row">
      <div class="elementNew" id="imageNew">
        Image
      </div>
    </div>
  </section>

  <footer>
    <a class="btn-editor btn-delete">Delete</a>
    <a class="btn-editor go-collection yellow_bg">Collection</a>
  </footer>

</script>

<script id="element_editor_tpl" type="text/html">
  <header>

  </header>

  <section>
    {{#hasBackgroundColor}}
    <div id="cp_backgroundColor" class="colorpicker go-cpDialog" style="background-color: {{backgroundColor}};">
    </div>
    {{/hasBackgroundColor}}
    {{#hasBorderColor}}
    <div id="cp_borderColor" class="colorpicker go-cpDialog" style="background-color: {{borderColor}};">
    </div>
    {{/hasBorderColor}}
    {{#hasFontColor}}
    <div id="cp_fontColor" class="colorpicker go-cpDialog" style="background-color: {{fontColor}};">
    </div>
    {{/hasFontColor}}
    {{#hasBorderThickness}}
    <div class="sizemodifier sm_borderThickness">
      <label>Border<input value="{{borderThickness}}" name="sm_borderThickness" /></label>
    </div>
    {{/hasBorderThickness}}
    {{#hasFontSize}}
    <div class="sizemodifier sm_fontSize">
      <label>Size<input value="{{fontSize}}" name="sm_fontSize" /></label>
    </div>
    {{/hasFontSize}}
    {{#hasWidth}}
    <div class="sizemodifier sm_width">
      <label>Width<input value="{{width}}" name="sm_width" /></label>
    </div>
    {{/hasWidth}}
    {{#hasHeight}}
    <div class="sizemodifier sm_height">
      <label>Height<input value="{{height}}" name="sm_height" /></label>
    </div>
    {{/hasHeight}}
    {{#hasRadius}}
    <div class="sizemodifier sm_r">
      <label>Radius<input value="{{r}}" name="sm_r" /></label>
    </div>
    {{/hasRadius}}
  </section>

  <footer>
    {{#isDeletable}}
    <a class="btn-editor btn-delete">Delete</a>
    {{/isDeletable}}
    <a class="btn-editor go-editor green_bg">Editor</a>
  </footer>

</script>

<script type="text/javascript">
  // Dependencies
  var Router = require('apily-router');
  var delegate = require('component-delegate');
  var event = require('component-event');
  var Emitter = require('component-emitter');
  var Raphael = require('richthegeek-raphael');

  // Happygui dependencies
  var View = require('happygui-view');
  var EditorView = require('happygui-editorview');
  var PreviewView = require('happygui-previewview');
  var PageView = require('happygui-pageview');

  // Happygui exceptions
  var NullElementException = require('happygui-nullelementexception');
  var NullCollectionException = require('happygui-nullcollectionexception');
  var NoPlatformException = require('happygui-noplatformexception');

  var StorageCtrl = require('happygui-storagectrl');

  // Views service
  var Views = function(editorView, previewView, pageView) {
    return {
      homepage: function() {

        pageView
            .render('homepage', null)

      },
      newpage: function() {

        pageView
            .render('newpage', null);

      },
      editor: function(collection) {

		    try {

		        editorView
		            .reset()
		            .select(collection)
		            .render();
	
		    } catch(exception) {
			  console.log(exception, exception.message);
		    
		    // TODO this should not appear in history
			  if (exception instanceof NullCollectionException) {
			  	this.currentCollection = null;
			    window.location = "#collection";
			    return null;
			  }
/*
		      if (exception instanceof NullElement) {
			  	this.currentElement = null;
			  }
*/

			}
			
			previewView
				.render(collection);

      },
      help: function() {

        pageView
            .render('help', null);

      },
      collection: function() {

        pageView
            .render("collection", {collection: StorageCtrl.getCollections()});

      },
      colorpicker: function(collection, type) {
        editorView
            .reset()
            .select(collection);

        editorView.colorpicker.type = type;
        editorView.colorpicker
            .show();

        previewView
            .render(collection);
      },
      element_colorpicker: function(collection, type, id) {
        editorView
            .reset()
            .select(collection, {id: id});

        editorView.colorpicker.type = type;
        editorView.colorpicker
            .show();

        previewView
            .render(collection);
      },
      element_editor: function(collection, type, id) {

        try {
          editorView
              .reset()
              .select(collection, {type: type, id: id});

          if (id) {
            editorView.render();
          } else {
            window.location = "#editor/"+collection+"/"+type+"/"+editorView.currentElement;
            // delete history
            return this;
          }

        } catch(exception) {

          // TODO this should not appear in history
          if (exception instanceof NullCollectionException) {
            this.currentCollection = null; //TODO CHECK
            window.location = "#collection";
            return null;
          } else if (exception instanceof NullElementException) {
            this.currentElement = null;
            window.location = "#editor/"+collection;
          } else {
            console.log(exception, exception.message);
          }

        }

        previewView
            .render(collection);

      }
    }
  };

  // Main
  var editor = new EditorView({container: 'editor', colorpicker: 'dialog_colorpicker'});
  var preview = new PreviewView({container: 'preview'});

  var page = new PageView({container: 'page'});
  var views = Views(editor, preview, page);

  // Clean before router cleans
  window.addEventListener("hashchange", function() {
    editor.hide();
    editor.colorpicker.hide();
    // TODO move preview paper clear from here
    // TODO dont clear/redraw when same collection
    preview.paper.clear();
    preview.hide();
    page.hide();
  }, true);

  var router = new Router();
  router
      .route('#homepage', views.homepage)
      .route('#new', views.newpage)
      .route("#help", views.help)
      .route("#collection", views.collection)
      .route('#editor/:collection', views.editor)
      .route('#editor/:collection/:type', views.element_editor)
      .route('#editor/:collection/:type/:id', views.element_editor)
      .route('#colorpicker/:collection/:type', views.colorpicker)
      .route('#colorpicker/:collection/:type/:id', views.element_colorpicker)
      .history.start();


  // This happens on page refresh
  if (window.location.hash === "") {
    window.location.hash = "#homepage"
  } else {
    //TODO load view
  }


</script>

</body>
</html>