<!DOCTYPE html>
<html>
<head>
  <title>HappyGUI</title>
  <link rel="stylesheet" type="text/css" href="css/default.css" />
</head>
<body>
<div class="wrapper">
  <div id="page"></div>
  <div id="editor" class="hidden">
    <!-- editorViews will be imported here -->
  </div>

  <div id="preview" class="hidden">
    <!-- elements drawn by the user -->
  </div>
</div>

<script type="text/javascript" src="js/handlebars.js"></script>
<script type="text/javascript" src="build/build.js"></script>

<script id="homepage_tpl" type="text/html">
  <div class="btn-block">
    <a href="#collection" class="btn green_bg">Open</a>
    <a href="#new" class="btn pink_bg">Create new</a>
    <a href="#help" class="btn yellow_bg">Help</a>
  </div>
</script>

<script id="newpage_tpl" type="text/html">
  <div class="centred" id="newpage">
    <div><input id="collectionName" placeholder="Enter a name" value=""/></div>
    <div id="collectionSave" class="btn orange_bg">Save</div>
  </div>
</script>

<script id="help_tpl" type="text/html">
  Help page
</script>

<script id="collection_tpl" type="text/html">
  {{#if collection }}
    {{#collection}}
      <a href="#editor/{{@index}}">
      <div class="collection">
        <div class="preview">
          <!-- Image here -->
        </div>
        <div class="title">{{name}}</div>
      </div>
      </a>
    {{/collection}}
  {{else}}
  <div class="centred">No app drawn yet, <a href="#new">create one!</a></div>
  {{/if}}
</script>

<script id="editor_tpl" type="text/html">
  <header>
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
  </header>

  <section id="elementsNew">
    <div class="elementNew" id="rectNew">
      Rect
    </div>
    <div class="elementNew" id="circleNew">
      Circle
    </div>
    <div class="elementNew" id="textNew">
      Text
    </div>
    <div class="elementNew" id="cameraNew">
      Camera
    </div>
    <div class="elementNew" id="imageNew">
      Image
    </div>
  </section>

  <footer>

  </footer>

</script>

<script id="element_editor_tpl" type="text/html">
  <header>

  </header>

  <section>
    {{#hasBackground}}
    <div class="colorpicker cpBackground" style="background-color: {{backgroundColor}};">
    </div>
    {{/hasBackground}}
    {{#hasBorderColor}}
    <div class="colorpicker cpBorderColor" style="background-color: {{borderColor}};">
    </div>
    {{/hasBorderColor}}
    {{#hasFontColor}}
    <div class="colorpicker cpFontColor" style="background-color: {{fontColor}};">
    </div>
    {{/hasFontColor}}
    {{#hasBorderThickness}}
    <div class="sizemodifier smBorderThickness">
      <label>Border thickness<input value="{{borderThickness}}" name="smBorderThickness" /></label>
    </div>
    {{/hasBorderThickness}}
    {{#hasFontSize}}
    <div class="sizemodifier smFontSize">
      <label>Font size<input value="{{fontSize}}" name="smFontSize" /></label>
    </div>
    {{/hasFontSize}}
  </section>

  <footer>
    {{#isDeletable}}
    <button class="btn-editor btn-delete">Delete</button>
    {{/isDeletable}}
  </footer>

</script>

<script type="text/javascript">
  // Dependencies
  var Router = require('apily-router');
  var delegate = require('component-delegate');
  var event = require('component-event');
  var Emitter = require('component-emitter');
  var gesture = require('component-gesture');

  // Happygui dependencies
  var Element = require('happygui-element');
  var TextElement = require('happygui-textelement');
  var ShapeElement = require('happygui-shapeelement');
  var Collection = require('happygui-collection');
  var View = require('happygui-view');
  var Templates = require('happygui-templates');

  /* Quick quick fix */
  Storage.prototype.setObject = function(key, value) {this.setItem(key, JSON.stringify(value));};
  Storage.prototype.getObject = function(key) {var value = this.getItem(key); return value && JSON.parse(value);};


  (function() {
    var elementGesture, height, image, offset, origin, prevScale, scale, screenOrigin, translate, width, wrap;

    // elementGesture = gesture(document.getElementsByClassName("element"));

    image = document.getElementsByClassName("element");
    gesture(image);
    wrap = document.getElementById("preview");
    width = 300;
    height = 300;
    offset = 100;
    origin = {
      x: 0,
      y: 0
    };
    screenOrigin = {
      x: 0,
      y: 0
    };
    translate = {
      x: 0,
      y: 0
    };
    scale = 1;
    prevScale = 1;

    elementGesture.on('transform start', function(e) {
      screenOrigin.x = (e.originalEvent.touches[0].clientX + e.originalEvent.touches[1].clientX) / 2;
      return screenOrigin.y = (e.originalEvent.touches[0].clientY + e.originalEvent.touches[1].clientY) / 2;
    });

    elementGesture.on('transform', function(event) {
      var newHeight, newWidth;
      scale = prevScale * event.scale;
      newWidth = 300 * scale;
      newHeight = 300 * scale;
      origin.x = screenOrigin.x - offset.left - translate.x;
      origin.y = screenOrigin.y - offset.top - translate.y;
      translate.x += -origin.x * (newWidth - width) / newWidth;
      translate.y += -origin.y * (newHeight - height) / newHeight;
      image.css('-webkit-transform', "scale3d(" + scale + ", " + scale + ", 1)");
      wrap.css('-webkit-transform', "translate3d(" + translate.x + "px, " + translate.y + "px, 0)");
      width = newWidth;
      return height = newHeight;
    });

    elementGesture.on('transform end', function(event) {
      return prevScale = scale;
    });
  })
      //.call(this);


  // Singleton
  var CollectionCtrl = (function(){

    var get = function () {
      if (localStorage) {
        return localStorage.getObject('happygui-collection');
      } else {
        return alert("You are using a platform which is not recognised!");
      }
    };

    var save = function () {
      if (localStorage) {
        localStorage.setObject('happygui-collection', filesCollection.models);
      } else {
        // TODO throw an error
        alert("You are using a platform which is not recognised!");
      }
    };

    var create = function (obj) {
      filesCollection.push(obj);
      save();
    };

    var reset = function () {
      filesCollection.models = [];
      if (localStorage) {
        localStorage.clear();
      } else {
        // TODO throw an error
        alert("You are using a platform which is not recognised!");
      }
    };

    var filesCollection = new Collection(get());

    return {
      get: function() {
        return filesCollection.models;
      },
      getCollection: function (collection) {
        return filesCollection.models[collection];
      },
      getElements: function(collection) {
        return filesCollection.models[collection].elements;
      },
      getElement: function(element, collection) {
        console.log("getElement", element, collection);
        return filesCollection.models[collection].elements[element];
      },
      delElement: function(element, collection) {
        filesCollection.models[collection].elements.splice(element, 1);
        save();
      },
      update: function (doc, collection) {
        if (doc && collection) {
          filesCollection.models[collection] = doc;
        }
        else if (doc) {
          filesCollection.models = doc;
        }
        save();
      },
      create: function() {
        var name = document.getElementById("collectionName").value;
        create({name: name, elements: []});
        document.getElementById("collectionName").value = '';
        window.location = "#editor/" + (filesCollection.length()-1);
        return this;
      },
      createElement: function (collection, doc) {
        var element;

        switch (doc.type) {
          case "image":
            break;
          case "circle":
            break;
          case "text":
            element = new TextElement(doc);
            break;
          default:

            //TODO throw error
            alert("type not recognised, sorry");
        }

        var index = filesCollection.models[collection].elements.push(element) - 1;
        console.log("createElement#index", index);
        return index;
      },
      reset: function() {
        if (confirm("Your data will be lost forever, are you fine with that?")) {
          reset();
        }
        return this;
      }
    }
  })();

  function PreviewView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "preview";

    return this;
  }
  PreviewView.prototype = Object.create(View.prototype);
  PreviewView.prototype.constructor = PreviewView;

  PreviewView.prototype.render = function (collection) {

    var collection = CollectionCtrl.getCollection(collection);

    var html = "", element, i = 0;

    for (i = 0; i < collection.elements.length; i++) {
      element = collection.elements[i];
      html += '<button id="el_'+i+'">'+element.type+'</button>';
    }

    this.el(html).show();
    return this;
  };

  function PageView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "page";

    return this;
  }
  PageView.prototype = Object.create(View.prototype);
  PageView.prototype.constructor = PageView;

  PageView.prototype.clear = function() {
    this.el('');
    return this;
  };

  PageView.prototype.render = function (template, data) {

    this
        .el(Templates.get(template)(data))
        .show();

    return this;
  };

  function EditorView (options) {
    View.call(this, options);
    options = options || {};

    this.defaultContainer = "editor";

    this.currentCollection = options.collection;
    this.currentElement = options.element || false;

    return this;
  }
  EditorView.prototype = Object.create(View.prototype);
  EditorView.prototype.constructor = EditorView;

  EditorView.prototype.collection = function () {
    return CollectionCtrl.getCollection(this.currentCollection);
  };
  EditorView.prototype.elements = function (element) {
    console.log("elements", element);
    if (element === null) {
      return CollectionCtrl.getElements(this.currentCollection);
    }

    return CollectionCtrl.getElement(element, this.currentCollection);
  };

  EditorView.prototype.setCollection = function (collection) {
    this.currentCollection = collection;
    // TODO throw errors
    return this;
  };

  EditorView.prototype.setElement = function (type, id) {
    // TODO throw errors
    if (type) {
      this.currentElement = id || CollectionCtrl.createElement(this.currentCollection, {type: type});
      console.log("setElement", editor.currentElement);
    } else {
      console.log("no type");
    }

    return this;
  };

  EditorView.prototype.select = function(collection, element) {

    element = element || {};

    this.setCollection(collection)
        .setElement(element.type, element.id);

    return this;
  };

  EditorView.prototype.reset = function () {
    this.currentCollection = null;
    this.currentElement = null;
    return this;
  };

  EditorView.prototype.render = function () {
    var html, data;

    if (this.currentElement !== null) {
      data = this.elements(this.currentElement);
      html = Templates.get("element_editor")(data);
    } else {
      data = this.collection();
      html = Templates.get("editor")(data);
    }

    this.el(html).show();

    return this;
  };

  // Views service
  var Views = function(editorView, previewView, pageView) {
    return {
      homepage: function() {

        pageView
            .render('homepage', null)

      },
      newpage: function() {

        pageView
            .render('newpage', null);

      },
      editor: function(collection) {

        editorView
            .reset()
            .select(collection, null)
            .render();

        previewView
            .render(collection);

      },
      help: function() {

        pageView
            .render('help', null);

        console.log("YUHU WE ARE IN help");
      },
      collection: function() {

        console.log("collection()", CollectionCtrl.get());
        pageView
            .render("collection", {collection: CollectionCtrl.get()});

      },
      element_editor: function(collection, type, id) {

        editorView
            .reset()
            .select(collection, {type: type, id: id})
            .render();

        previewView
            .render(collection);

      }
    }
  };

  // Main
  var editor = new EditorView({container: 'editor'});
  editor.bind('click .elementNew', function(e) {
    var type = e.target.id.replace('New','');
    window.location = "#editor/"+editor.currentCollection+"/"+type;
  });
  editor.bind('click #editor .btn-delete', function(e) {
    CollectionCtrl.delElement(editor.currentElement, editor.currentCollection);
    window.location = "#editor/"+editor.currentCollection;
  });
  editor.bind('click #editor .colorpicker', function(e) {
    // TODO use external libs
    alert("Pick a color");
  });

  var preview = new PreviewView({container: 'preview'});

  // Only for testing
  preview.bind('click #preview button', function(e) {
    // TODO delete this
    var elementId = parseInt(e.target.id.replace("el_",''));
    var element = CollectionCtrl.getElement(elementId, editor.currentCollection);
    window.location = "#editor/"+editor.currentCollection+"/"+element.type+"/"+elementId;
  });

  var page = new PageView({container: 'page'});
  page.bind('click #collectionSave', CollectionCtrl.create);
  var views = Views(editor, preview, page);

  // Clean before router cleans
  window.addEventListener("hashchange", function() {
    editor.hide();
    preview.hide();
    page.hide();
  }, true);

  var router = new Router();
  router
      .route('#homepage', views.homepage)
      .route('#new', views.newpage)
      .route("#help", views.help)
      .route("#collection", views.collection)
      .route('#editor/:collection', views.editor)
      .route('#editor/:collection/:type', views.element_editor)
      .route('#editor/:collection/:type/:id', views.element_editor)
      .history.start();


  // This happens on page refresh
  if (window.location.hash === "") {
    window.location.hash = "#homepage"
  } else {
    //TODO load view
  }


</script>

</body>
</html>